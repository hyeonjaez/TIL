# 2. 토큰 기반 인증, 인가


### 인증 vs 인가
- 인증 : 사용자의 신원을 확인
- 인가 : 신원 확인된 사용자가 특정 리소스에 접근할 권한이 있는지 확인
<br/>

---

### 세션 기반의 한계
- 서버가 확장되면 즉, 로드벨런싱 환경에서는 각 서버마다의 독립된 세션 저장소가 있어서 세션 동기화가 필요하다.
- 사용자 데이터를 서버가 가지고 있어 그만큼 서버 부하가 커진다.

### 토큰 기반 
- 서버가 로그인 시 JWT 토큰 발급을 하면 클라이언트에 저장한다.
- 서버는 세션을 저장하지 않는다.
- 토큰만 있으면 분산환경에서도 인증이 가능하다.

<br/>

---

### JWT(Json Web Token)
- JSON 객체를 안전하게 전송하기 위한 토큰 표준
- JSON 데이터를 Base64 URL-safe 방식으로 인코딩하여 직렬화한 토큰
- AccessToken, RefreshToken 둘 다 JWT 형태로 발급하는 경우가 많다.

### JWT 구조

- 1. Header
     - typ : 토큰 유형 표시
     - alg : 알고리즘 유형 표시
- 2. Payload
     - 사용자 정보
     - 클레임
     - 권한등등
- 3. Signature
     - Header와 Payload를 비밀 키를 사용해서 암호화한 서명이다.
     - JWT의 위조를 방지하고 유효성을 검증하는데 사용됨
    
### Access Token vs Refresh Token
- Access Token
  - 인증된 클라이언트가 리소스에 접근하기 위해 사용하는 토큰이다.
  - 짧은 유효 기간
  - 사용자가 로그인하면 서버에서 Access Token을 발급하여 클라이언트에 전달한다
 
- Refresh Token
  - 새로운 Access Token을 재발급받기 위해 사용하는 토큰
  - 긴 유효기간
  - 클라이언트에 저장하지 않고 주로 데이터베이스 같은 저장소에 저장된다
  - Access Token이 만료되었을때 클라이언트가 다시 인증 과정을 요구받지 않고 RefreshToken 을 이용해서 새로운 Access Token을 발급받는다.
 
<br/>

---


### 전체 흐름

1. 사용자가 로그인 요청한다. -> 서버에서 사용자 인증
2. 정상적으로 처리가 되면 서버는 Access Token을 발급하고 클라이언트에 주고 Refresh Token은 발급하여 데이터베이스 같은 곳에 저장한다.
3. Access Token 이 만료될때 까지 사용자는 권한이 있는 리소스에 접근할 수 있다.
4. 만료가 되었는데 리소스에 접근한다면 서버는 Refresh Token이 있는지 확인을 하고 유효한지 확인한다.
5. Refresh Token이 있고 유효하다면 Access Token을 재발급해준다
6. 만약 없거나 유효하지 않다면 다시 로그인해야 한다.


### 토큰의 단점

- Token 탈취시에 보안에 위험하다.
- Payload가 평문으로 되어 있어 민감한 정보 저장은 금지한다.
- RefreshToken이 탈취당하면 답이 없다.
- 토큰 강제 무효화가 어렵다.


<br/>

---

### Bearer Token 
- JWT 기반 인증에서 많이 쓰이는 방식
- 토큰 소지자가 곧 권한을 가진다는 의미이다.

HTTP AUthorization 헤더 
```http
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```
- Authorization : HTTP 표준 헤더
- Bearer : 토큰을 사용한 인증 방식이라고 명시
- 클라이언트가 API 요청을 보낼때 직접 Authorization 헤더에 Bearer Token을 추가해야한다.
- 그래서 서버는 이 토큰을 꺼내서 검증을 한다.

### Bearer Token 주의 사항
- 토큰은 평문으로 전송이 되어서 HTTPS가 아니면 탈취 위험이 있다.
- Access Token의 유효기간을 짧게 해서 만약에 탈취 당하더라도 피해를 최소화한다.
- Refresh Token은 DB 같은곳에 저장하는게 안전하다
