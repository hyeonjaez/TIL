## 29. 낙관적 락에서 버전이 쓰이는 방식

### 🧠 개념 설명
**낙관적 락**
- 동시에 수정이 일어나더라도 충돌은 드물 것이다 라고 낙관적으로 가정한다
- 데이터를 읽을 때는 락을 걸지 않고 수정 시점에만 충돌 여부를 검사한다

**방식**

1. 버전 필드 설정
- 엔티티에 @Version 어노테이션이 붙은 int or long 타입의 칼럼을 둔다

2. 조회시
- 엔티티를 조회하면 JPA가 해당 시점의 version 값을 같이 가져온다

3. 수정시
- 트랜잭션이 끝나고 UPDATE 할때 JPA는 WHERE 조건에 현재 엔티티의 id와 version을 사용하한다
- 내가 처음 조회한 version값과 DB의 version 값이 같아야 업데이트가 된다

4. 충돌 감지
- 만약 다른 트랜잭션이 먼저 같은 엔티티를 수정했으면 DB의 version 값이 증가해 있다
- 수정하려는 시점에서 WHERE id = ? AND version = ? 조건이 불일치 -> UPDATE 0건 발생
- JPA는 이걸 감지해서 OptimisticLockException을 던진다

---
### ✅ 한줄로 설명 하기
- 낙관적 락에서 버전은 엔티티가 변경될 때마다 증가하고 UPDATE 시점에 WHERE 조건으로 충돌 여부를 검증하는 방식으로 동시성 제어 한다
