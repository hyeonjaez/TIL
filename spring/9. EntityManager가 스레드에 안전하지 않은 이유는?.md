## 9. EntityManager가 스레드에 안전하지 않은 이유는?

### 🧠 개념 설명

**Entity Manager**
- JPA에서 엔티티를 관리(저장, 조회, 수정, 삭제) 하는 인터페이스 
- Persistence Context(영속성 컨텍스트)를 관리한다
- EntityManager 는 DB와 직접 연결된게 아니라 1차 캐시, 변경 감지, 쓰기 지연 SQL 저장소 같은 상태를 보관하고 있다

**왜 스레드 안전하지 않을까?**

1. 1차 캐시를 가짐
- EntityManager는 영속성 컨텍스트를 내부적으로 보관하고 있다
- 여러 스레드가 동시에 같은 EntityManager를 사용하게 된다면
  - 한 스레드가 엔티티를 저장해서 1차 캐시에 추가하는 순간에 다른 스레드가 그 캐시를 건드리게 된다면 데이터 정합성이 깨진다
 
2. 트랜잭션 경계와 밀접한 연관
- EntityManager는 트랜잭션 단위로 생성되고 닫힌다
- 여러 스레드가 동시에 접근하면 어떤 트랜잭션이 flush/rollback 해야 할지 충돌이 발생한다

3. 동기화 장치 없음
- EntityManager 자체가 동시성 제어를 하지 않는다
- 멀티 스레드 환경에서 동시에 접근하면 race condition 발생

<br/>


**EntityManager와 영속성 컨텍스트 관계**

영속성 컨텍스트
- 엔티티를 1차 캐시에 보관하고 관리하는 공간
- 엔티티의 생명주기 관리
  - 비영속 -> 영속 -> 준영속 -> 삭제
- 변경 감지, 쓰기 지연, flush 같은 기능도 이 안에서 일어남
- DB와 애플리케이션 사이의 중간 저장소, 엔티티 관리 역할을 한다고 볼 수 있다.


관계
- 영속성 컨텍스트는 실제 엔티티를 관리하는 공간
- entity manager는 이 컨텍스트를 다루는 인터페이스
- 둘은 항상 1:1로 연결됨 -> 하난의 EntityManager는 하나의 영속성 컨텍스트 를 가진다



---
### ✅ 한줄로 설명 하기

- EntityManager 내부에 상태를 가지고 있어서 여러 스레드가 동시에 접근하면 데이터 정합성이 깨져서 스레드에 안전하지 않는다.
