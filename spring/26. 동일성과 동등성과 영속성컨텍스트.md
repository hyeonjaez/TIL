## 26. 동일성과 동등성과 영속성컨텍스트

### 🧠 개념 설명
**동일성**
- (==)
- 두 객체의 메모리 참조가 같은지를 비교한다
- 메모리 상에서 주소가 같은지 같은 인스턴스인가? 를 비교하는 것

```java
user1 == user2
```

**동등성**
- (.equals)
- 두 객체의 값이 같은지를 비교
- 참조가 달라도 같은 속성을 가지면 true일 수 있다

```java
user1.equals(user2)
```

<br/>

**영속성 컨텍스트가 동일성을 보장한다는 뜻**


- 영속성 컨텍스트는 1차 캐시를 사용해서 같은 엔티티를 두번 조회하면 항상 같은 객체 인스턴스를 반환한다

```java
EntityManger em;

User user1= em.find(User.class, 1);

User user2 = em.find(User.class, 1);


System.out.println(user1 == user2);
System.out.println(user1.equals(user2));
```
- 같은 영속성 컨텍스트 안에서 같은 PK를 가진 엔티티는 항상 하나의 인스턴스로 관리된다
- 그래서 개발자는 == 연산으로 비교해도 동일성을 확인할 수 있다

**그럼 어떻게 동일성을 보장할까?**

1차 캐시
- 영속성 컨텍스트는 Map<PK, 엔티티 인스턴스> 구조로 1차 캐시를 가지고 있다
- em.find() 같은 조회가 오면 JPA는 DB 조회전에 먼저 1차 캐시를 확인한다
  - 캐시에 있다면 : 같은 객체를 반환
  - 캐시에 없다면 : DB에서 조회 -> 객체 생성 후에 캐시에 넣고 반환
- 이렇게 항상 캐시에 있는 동일 객체를 반환하기 때문에 동일성이 보장된다


---
### ✅ 한줄로 설명 하기
- 동일성은 == 으로 실제 같은 객체인지 여부, 동등성은 .equals() 기준으로 값이 같은지 여부
- 같은 트랜잭션 범위 내에서는 같은 PK의 엔티티는 무조건 같은 객체 참조로 반환된다
- 왜냐하면 영속성 컨텍스트는 1차 캐시를 두고 같은 영속성 컨텍스트 내에서 동일한 PK 엔티티를 하나의 인스턴스로만 관리하기 때문이다

