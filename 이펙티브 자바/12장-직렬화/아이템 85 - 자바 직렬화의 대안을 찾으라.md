## 아이템 85 - 자바 직렬화의 대안을 찾으라

**직렬화, 역직렬화**
- 직렬화 : 객체를 바이트 스트림으로 변환하여 저장하거나 네트워크로 전송하는 과정
- 역직렬화 : 바이트 스트림을 객체로 복원하는 과정

<br/>

**문제점 1**
- 직렬화된 데이터는 객체 그래프 전체 정보가 들어 있다
- 역직렬화 과정에서 공격자가 임의의 코드를 실행시킬 수 있다
- ObjectInputStream.readObject() 는 공격자가 조작한 스트림을 읽을 때 임의의 코드가 실행될 위험이 있다

<br/>

**문제점 2**
- 객체 그래프 전체가 자동으로 변환되어서 복잡한 클래스 구조나 순환 참조가 포함되면 예측이 어렵다
- 클래스 버전이 바뀌면 역직렬화가 실패하거나 데이터가 잘못 복원될 수 있다
- private 필드까지 외부로 노출되어 캡슐화가 깨질수 잇따
- 직렬화는 클래스 설계에 숨은 제약을 만들어내어 시스템 간 결합도를 높여 유연성을 해친다


**문제점 3**
```java
static byte[] bomb() {
    Set<Object> root = new HashSet<>();
    Set<Object> s1 = root;
    Set<Object> s2 = new HashSet<>();
    for (int i = 0; i < 100; i++) {
        Set<Object> t1 = new HashSet<>();
        Set<Object> t2 = new HashSet<>();
        t1.add("foo"); // dummy
        s1.add(t1);
        s1.add(t2);
        s2.add(t1);
        s2.add(t2);
        s1 = t1;
        s2 = t2;
    }
    return serialize(root);
}
```
- 역직렬화 폭탄은 단 한줄의 readObject() 호출만으로도 시스템을 마비시킬수 있다.


<br/>

**대안**
- 직렬화를 피하라
- 데이터를 외부로 보낼 때는 대체 포맷을 사용하라
- Json
- Protocol Buffers
- 이런 대안들은 명시적이고 안전하고 버전 관리가 용이하다

<br/>

**직렬화를 써야한다면**
1. 신뢰할 수 없는 데이터는 절대 역직렬화 하지 말자
  - ObjectInputStream.readObject()는 외부 입력에서 절대 호출하지 말자

2. readObject()를 재정의할 경우 반드시 방어 코드 추가
  - 입력값 검증
  - 불변식 보장확인

3. java.io.Externalizable 구현은 피하자
  - 너무 저수준이고 직접 버전 호환성을 관리해야 한다


<br/>

**자바 9부터**
- 자바 9 이후부터는 ObjectInputFilter를 통해서 역직렬화 가능한 클래스나 객체 크기를 화이트 리스트 방식으로 제한할 수 있다
- 하지만 이것도 임시 방편이라 가장 좋은 방법은 아예 쓰지 않는것이다

<br/>

**나의 정리**
- 직렬화는 보안, 성능, 유지보수성 측면에서 모두 위험하다
- readObject()는 외부 입력에서 절대 호춯하지 말아야하고
- Json 같은 대안을 사용하면 데이터 구조를 명시적으로 설계하고 버전 호환성을 쉽게 유지할 수 있다
- 직렬화를 사용하는 대신에 명시적이고 안전한 데이터 포맷을 설계하자
- 가장 안전한 방법은 하지 않는것
