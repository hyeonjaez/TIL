## 아이템 89 - 인스턴스 수를 통제해야 한다면 readResolve보다는 열거 타입을 사용하라

**역직렬화가 싱글턴을 깨뜨린다**
- 역직렬화는 생성자를 거치지 않고 새 객체를 만든다

**readResolve의 역할**
- 역직렬화로 만들어진 임시 객체 대신 항상 지정된 인스턴스를 반환하여 인스턴스 통제한다

**모든 참조 타입 필드를 transient**
- 임시 객체에 악의적인 객체가 주입되는 것을 차단
- 역직렬화 중간 단계에서 불변식 훼손, 부작용, 자원 낭비를 막는다
- 필요한 상태는 정규 인스턴 쪽에서 재구성

<br/>

**readResolve**
- 역직렬화 후 반환할 객체를 원하는 인스턴스로 교체할 수 있다
- 이 방식으로 싱글턴 보장이 가능하긴 하다

**readResolve 단점**
1. 방어 코드가 필요함
  - 생성자나 필드가 Accessible 상태라면 우회가 가능하다
  - 공격자가 readObject 단계에서 조작해 새로운 인스턴스를 만들 수도 있다
2. 필드를 final로 해도 안전하지 않는다
  - 역직렬화 과정에서 final 필드 조차 공격자가 덮어쓸 수 있다
3. 보일러 플레이트 코드 증가
  - 매번 readResolve 작성 및 방어 로직을 넣어야 한다

<br/>

**열거 타입으로 싱글턴 구현**
- enum은 자바가 직렬화, 역직렬화를 안전하게 보장한다
- 역직렬화 시에도 항상 같은 인스턴스가 반환된다
- JVM이 인스턴스 생성을 통제해서 리플렉션 공격에도 안전하다


<br/>

**예외 상황**
- enum은 싱글턴이나 소수의 인스턴스만 필요한 경우에 적합
- 상속이 필요한 경우에는 사용할수 없음
- 이런 경우에는 여전히 readResolve 를 통해 인스턴스 통제를 고려해야 한다

<br/>

**직렬화와 인스턴스 통제가 모두 필요하다면**
- readResolve 메서드를 작성해 넣고
- 참조 필드를 transient로 만들어 임시 객체에 상태 주입을 방지하자
- 직렬화 형태를 앏게 유지하자
